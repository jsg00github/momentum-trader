// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Antigravity

//@version=6
indicator("Antigravity W.RSI Refined", overlay=false, format=format.price, precision=2)

// --- INPUTS ---
rsiTimeframe = input.timeframe("W", "RSI Timeframe")
rsiLength    = input.int(14, "RSI Length", minval=1)
ema3Length   = input.int(3, "EMA 3 Length", minval=1)
ema14Length  = input.int(14, "EMA 14 Length", minval=1)
ema21Length  = input.int(21, "EMA 21 Length", minval=1)

// --- CALCULATION ---
// Calculate RSI on weekly timeframe
rsiValueRaw = ta.rsi(close, rsiLength)
rsiWeekly   = request.security(syminfo.tickerid, rsiTimeframe, rsiValueRaw, lookahead=barmerge.lookahead_on)

// EMAs of the RSI
ema3  = ta.ema(rsiWeekly, ema3Length)
ema14 = ta.ema(rsiWeekly, ema14Length)
ema21 = ta.ema(rsiWeekly, ema21Length)

// --- COLOR LOGIC (6-TIER) ---
// Green: RSI > 50, RSI > EMA3, RSI > EMA14 (Strong Bullish)
// Pink:  RSI > 50, RSI < EMA3, RSI < EMA14 (Correction in Uptrend)
// Yellow: RSI > 50, intermediate EMAs (Pullback above midline)
// Blue:  RSI <= 50, RSI > EMA3, RSI > EMA14 (Accumulation)
// Orange: RSI <= 50, intermediate EMAs (Pullback below midline)
// Red:   RSI < EMA14 (Bearish)

color rsiColor = color.gray // Default

if rsiWeekly > 50
    if rsiWeekly > ema3 and rsiWeekly > ema14
        rsiColor := #10b981 // Green (Emerald 500)
    else if rsiWeekly < ema3 and rsiWeekly < ema14
        rsiColor := #f472b6 // Pink (Pink 400)
    else
        rsiColor := #f59e0b // Yellow (Amber 500)
else // RSI <= 50
    if rsiWeekly > ema3 and rsiWeekly > ema14
        rsiColor := #3b82f6 // Blue (Blue 500)
    else if rsiWeekly < ema14
        rsiColor := #ef4444 // Red (Red 500)
    else
        rsiColor := #f97316 // Orange (Orange 500)

// --- PLOTTING ---
// Histogram with transparency
plot(rsiWeekly, "RSI Histogram", color.new(rsiColor, 70), 4, plot.style_columns)
// White line for definition
plot(rsiWeekly, "RSI Line", color.white, 2, plot.style_line)

// EMAs for context
plot(ema3,  "W.EMA 3",  color.new(#10b981, 0), 1)
plot(ema14, "W.EMA 14", color.new(#f43f5e, 0), 1)
plot(ema21, "W.EMA 21", color.new(#8b5cf6, 40), 1, plot.style_linebr)

// Midline and levels
hline(70, "Overbought", color.new(#ef4444, 40), hline.style_dashed)
hline(50, "Midline",    color.new(#94a3b8, 60), hline.style_dotted)
hline(30, "Oversold",   color.new(#22c55e, 40), hline.style_dashed)

// Background color for clarity if needed
// bgcolor(rsiColor, transp=90)
